@page "/Queries/Create"
@inherits QueryBase

<RadzenTemplateForm TItem="CreateQueryRequest" Data="_input" Submit="CreateQueryAsync">
    <RadzenRow>
        <RadzenColumn Size="6">
            <RadzenFormField Text="Name" class="w-100">
                <RadzenTextBox @bind-Value="@_input.Name" Name="Name" />
                <RadzenRequiredValidator Component="Name" Text="Name is required" Popup />
                <RadzenLengthValidator Component="Name" Max="50" Min="3" Popup />
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="6">
            <RadzenFormField Text="Data Source" class="w-100">
                <RadzenDropDownDataGrid 
                    TValue="int?"
                    Value="@_input.DataSourceId"
                    ValueChanged="DataSourceChangedAsync"
                    LoadData="LoadDataSourcesAsync" 
                    Data="DataSources"
                    Count="TotalDataSources"
                    AllowVirtualization
                    AllowClear
                    AllowFiltering="false"
                    TextProperty="@nameof(DataSourceListItem.Name)"
                    ValueProperty="@nameof(DataSourceListItem.Id)"
                    Name="Data Source"
                    Context="datasource">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(DataSourceListItem.Name)" Title="Name" />
                        <RadzenDropDownDataGridColumn Property="@nameof(DataSourceListItem.QueryRunnerId)" Title="Runner">
                            <Template Context="data">
                                @if (data is DataSourceListItem item && item != null)
                                {
                                    <QueryRunnerDisplay Name="@item.QueryRunnerName" RunnerIcon="@item.QueryRunnerIcon"/>
                                }
                            </Template>
                        </RadzenDropDownDataGridColumn>
                    </Columns>
                    <ValueTemplate>
                        @if (datasource is DataSourceListItem item && item != null)
                        {
                            @item.Name @:-
                            <QueryRunnerDisplay Name="@item.QueryRunnerName" RunnerIcon="@item.QueryRunnerIcon" />
                        }
                    </ValueTemplate>
                </RadzenDropDownDataGrid>
            </RadzenFormField>
        </RadzenColumn>
    </RadzenRow>
    <RadzenRow>
        <RadzenColumn>
            <RadzenFormField Text="Description" class="w-100">
                <RadzenTextBox @bind-Value="@_input.Description" Name="Description" />
                <RadzenLengthValidator Component="Description" Max="500" Popup />
            </RadzenFormField>
        </RadzenColumn>
    </RadzenRow>
    <RadzenRow>
        <RadzenColumn Size="12" Style="padding-top: 4px; padding-bottom: 4px">
            <StandaloneCodeEditor Id="query-editor" ConstructionOptions="EditorConstructionOptions" @ref="_editor" CssClass="query-editor w-100 h-100" />
        </RadzenColumn>
    </RadzenRow>
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit">Save</RadzenButton>
        </RadzenColumn>
    </RadzenRow>
</RadzenTemplateForm>